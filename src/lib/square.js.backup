// Square SDKé–¢é€£ã®å‹å®šç¾©
let payments = null

// Square SDKã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadSquareSDK() {
  if (window.Square) {
    return
  }
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script')
    script.src = 'https://sandbox.web.squarecdn.com/v1/square.js'
    script.async = true
    script.onload = () => resolve()
    script.onerror = () => reject(new Error('Failed to load Square SDK'))
    document.head.appendChild(script)
  })
}

// Squareæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
export async function initializeSquare() {
  try {
    if (!payments) {
      await loadSquareSDK()
      
      // ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
      let applicationId = import.meta.env.VITE_SQUARE_APPLICATION_ID
      
      // Application IDãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ããªã„å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆç”¨ã®IDã‚’ä½¿ç”¨
      if (!applicationId || !applicationId.startsWith('sandbox-sq0idb-')) {
        console.warn('æ­£ã—ã„Square Application IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆç”¨IDã‚’ä½¿ç”¨ã—ã¾ã™ã€‚')
        applicationId = 'sandbox-sq0idb-uF6_Dtbww6cjmxmDlprGNQ' // éƒµä¾¿ç•ªå·ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å•é¡Œã«å¯¾å¿œã—ãŸãƒ†ã‚¹ãƒˆç”¨ID
      }
      
      payments = await window.Square.payments(applicationId)
    }
    return payments
  } catch (error) {
    console.error('Square SDKã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
    throw error
  }
}

// ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
export async function createCardPaymentForm(payments, zipCode = '') {
  try {
    const card = await payments.card({
      style: {
        input: {
          color: '#333',
          fontSize: '16px',
          fontFamily: 'Arial, sans-serif'
        },
        'input::placeholder': {
          color: '#999'
        },
        '.message-text': {
          color: '#dc3545'
        }
      }
      // postalCodeã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆç„¡åŠ¹ãªè¨­å®šã®ãŸã‚ï¼‰
    })
    
    // ã‚«ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’ #card-container ã«ã‚¢ã‚¿ãƒƒãƒ
    await card.attach('#card-container')
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¿ãƒƒãƒå¾Œã€éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–ã™ã‚‹
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
    }, 100)
    
    // å°‘ã—é…ã‚‰ã›ã¦ã‚‚ã†ä¸€åº¦ç¢ºèªãƒ»ç„¡åŠ¹åŒ–
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
      logFormInputs() // ãƒ‡ãƒãƒƒã‚°ç”¨
    }, 500)
    
    // ã•ã‚‰ã«é…ã‚‰ã›ã¦æœ€çµ‚ç¢ºèª
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
    }, 1000)
    
    // MutationObserverã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è¦ç´ ã‚’ç›£è¦–
    if (zipCode) {
      setupDynamicPostalCodeHandler(zipCode)
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¿ãƒƒãƒå¾Œã€éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–ã™ã‚‹
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
    }, 100)
    
    // å°‘ã—é…ã‚‰ã›ã¦ã‚‚ã†ä¸€åº¦ç¢ºèªãƒ»ç„¡åŠ¹åŒ–
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
      logFormInputs() // ãƒ‡ãƒãƒƒã‚°ç”¨
    }, 500)
    
    // ã•ã‚‰ã«é…ã‚‰ã›ã¦æœ€çµ‚ç¢ºèª
    setTimeout(() => {
      disablePostalCodeFields(zipCode)
    }, 1000)
    
    return card
  } catch (error) {
    console.error('ã‚«ãƒ¼ãƒ‰æ”¯æ‰•ã„ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
    throw error
  }
}

// éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å°‚ç”¨é–¢æ•°
function disablePostalCodeFields(zipCode = '') {
  console.log('ğŸ” éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç„¡åŠ¹åŒ–ã‚’é–‹å§‹... éƒµä¾¿ç•ªå·:', zipCode)
  
  // ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªéƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œç´¢ã‚»ãƒ¬ã‚¯ã‚¿
  const postalCodeSelectors = [
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹
    '[placeholder*="postal" i]',
    '[placeholder*="zip" i]',
    '[placeholder*="éƒµä¾¿" i]',
    
    // nameå±æ€§ãƒ™ãƒ¼ã‚¹
    'input[name*="postal" i]',
    'input[name*="zip" i]',
    'input[name*="éƒµä¾¿" i]',
    
    // idå±æ€§ãƒ™ãƒ¼ã‚¹
    'input[id*="postal" i]',
    'input[id*="zip" i]',
    'input[id*="éƒµä¾¿" i]',
    
    // classå±æ€§ãƒ™ãƒ¼ã‚¹
    '.sq-postal-code input',
    '.postal-code input',
    '.zip-code input',
    
    // dataå±æ€§ãƒ™ãƒ¼ã‚¹
    '[data-testid="postal-code"] input',
    '[data-testid="zip-code"] input',
    
    // Squareå›ºæœ‰ã®ã‚»ãƒ¬ã‚¯ã‚¿
    '.sq-form .sq-input-postal',
    '.sq-form input[type="text"]:last-child', // æœ€å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¤šãã®å ´åˆéƒµä¾¿ç•ªå·ï¼‰
    
    // ã‚ˆã‚Šä¸€èˆ¬çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆSquareç‰¹æœ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    '#card-container input[type="text"]',
    '#card-container .sq-input'
  ]
  
  let foundFields = 0
  let allTextInputs = []
  
  // ã¾ãšå…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
  const cardContainer = document.getElementById('card-container')
  if (cardContainer) {
    allTextInputs = Array.from(cardContainer.querySelectorAll('input[type="text"]'))
    console.log(`ğŸ“‹ ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${allTextInputs.length}å€‹`)
    
    allTextInputs.forEach((input, index) => {
      console.log(`  Input ${index}:`, {
        placeholder: input.placeholder,
        name: input.name,
        id: input.id,
        value: input.value,
        className: input.className
      })
    })
  }
  
  // ç‰¹å®šã®ã‚»ãƒ¬ã‚¯ã‚¿ã§éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œç´¢
  postalCodeSelectors.forEach(selector => {
    try {
      const inputs = document.querySelectorAll(selector)
      inputs.forEach(input => {
        if (input && input.type !== 'hidden' && !input.disabled) {
          foundFields++
          console.log(`âœ… éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç™ºè¦‹ (${selector}):`, input)
          
          // éƒµä¾¿ç•ªå·ã‚’è¨­å®šã—ã¦ã‹ã‚‰ç„¡åŠ¹åŒ–
          if (zipCode) {
            console.log(`ğŸ“ éƒµä¾¿ç•ªå·ã‚’è¨­å®š: ${zipCode}`)
            input.value = zipCode
          }
          
          // å®Œå…¨ç„¡åŠ¹åŒ–ã®å‡¦ç†
          input.disabled = true
          input.readOnly = true
          
          // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‹ã‚‰é™¤å¤–
          input.removeAttribute('name')
          input.removeAttribute('required')
          
          // å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹
          input.style.display = 'none !important'
          input.style.visibility = 'hidden !important'
          input.style.height = '0px !important'
          input.style.width = '0px !important'
          input.style.position = 'absolute !important'
          input.style.left = '-9999px !important'
          input.style.top = '-9999px !important'
          input.style.overflow = 'hidden !important'
          
          // è¦ªè¦ç´ ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
          if (input.parentElement) {
            const parent = input.parentElement
            
            // è¦ªè¦ç´ ã«ä»–ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã®ã¿éè¡¨ç¤º
            const otherInputs = parent.querySelectorAll('input:not([disabled])')
            if (otherInputs.length <= 1) {
              parent.style.display = 'none !important'
              console.log('âœ… è¦ªè¦ç´ ã‚‚éè¡¨ç¤ºã«ã—ã¾ã—ãŸ:', parent)
            }
          }
        }
      })
    } catch (e) {
      console.log(`âš ï¸ ã‚»ãƒ¬ã‚¯ã‚¿ã‚¨ãƒ©ãƒ¼ (${selector}):`, e.message)
    }
  })
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ï¼šæœ€å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éƒµä¾¿ç•ªå·ã¨ã—ã¦å‡¦ç†
  if (foundFields === 0 && allTextInputs.length > 0) {
    console.log('âš ï¸ ç‰¹å®šã®éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†ã—ã¾ã™ã€‚')
    
    const lastInput = allTextInputs[allTextInputs.length - 1]
    if (lastInput) {
      console.log('ğŸ¯ æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éƒµä¾¿ç•ªå·ã¨ä»®å®šã—ã¦å‡¦ç†:', lastInput)
      
      // éƒµä¾¿ç•ªå·ã‚’è¨­å®š
      if (zipCode) {
        console.log(`ğŸ“ æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«éƒµä¾¿ç•ªå·ã‚’è¨­å®š: ${zipCode}`)
        lastInput.value = zipCode
        
        // å€¤ãŒæ­£ã—ãè¨­å®šã•ã‚ŒãŸã‹ç¢ºèª
        setTimeout(() => {
          console.log(`âœ… è¨­å®šå¾Œã®å€¤ç¢ºèª: ${lastInput.value}`)
        }, 100)
      }
      
      lastInput.disabled = true
      lastInput.style.display = 'none !important'
      foundFields++
    }
  }
  
  // ã•ã‚‰ãªã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€å¾Œã®2ã¤ã‚’ç¢ºèª
  if (foundFields === 0 && allTextInputs.length >= 2) {
    console.log('ï¿½ è¿½åŠ ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæœ€å¾Œã®2ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª')
    
    // æœ€å¾Œã‹ã‚‰2ç•ªç›®ã¨æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
    const candidates = allTextInputs.slice(-2)
    candidates.forEach((input, index) => {
      console.log(`ğŸ§ å€™è£œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ${index}:`, {
        placeholder: input.placeholder,
        maxLength: input.maxLength,
        pattern: input.pattern,
        value: input.value
      })
      
      // maxLengthãŒ5-10ã®ç¯„å›²ã€ã¾ãŸã¯patternãŒéƒµä¾¿ç•ªå·ã£ã½ã„å ´åˆ
      if ((input.maxLength >= 5 && input.maxLength <= 10) || 
          (input.pattern && input.pattern.includes('zip')) ||
          (input.placeholder && input.placeholder.toLowerCase().includes('zip'))) {
        console.log(`ğŸ¯ å€™è£œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éƒµä¾¿ç•ªå·ã¨ã—ã¦å‡¦ç†: ${index}`)
        
        if (zipCode) {
          input.value = zipCode
          console.log(`ğŸ“ å€™è£œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«éƒµä¾¿ç•ªå·ã‚’è¨­å®š: ${zipCode}`)
        }
        
        input.disabled = true
        input.style.display = 'none !important'
        foundFields++
      }
    })
  }
  
  console.log(`âœ… éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†å®Œäº†: ${foundFields}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†`)
  return foundFields
}

// ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚©ãƒ¼ãƒ å†…ã®å…¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ã‚°å‡ºåŠ›
function logFormInputs() {
  console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ å†…ã®å…¨å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:')
  const allInputs = document.querySelectorAll('#card-container input')
  allInputs.forEach((input, index) => {
    console.log(`  Input ${index}:`, {
      type: input.type,
      placeholder: input.placeholder,
      name: input.name,
      id: input.id,
      disabled: input.disabled,
      value: input.value,
      style: input.style.display
    })
  })
}

// å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç›£è¦–ãƒ»å‡¦ç†ã™ã‚‹
function setupDynamicPostalCodeHandler(zipCode) {
  console.log('ğŸ”„ å‹•çš„éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç›£è¦–ã‚’é–‹å§‹:', zipCode)
  
  const cardContainer = document.getElementById('card-container')
  if (!cardContainer) return
  
  // MutationObserverã§æ–°ã—ã„è¦ç´ ã®è¿½åŠ ã‚’ç›£è¦–
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // æ–°ã—ã„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ
            const newInputs = node.querySelectorAll ? node.querySelectorAll('input[type="text"]') : 
                             (node.tagName === 'INPUT' && node.type === 'text') ? [node] : []
            
            newInputs.forEach((input) => {
              console.log('ğŸ†• æ–°ã—ã„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œå‡º:', input)
              
              // é…å»¶ã—ã¦éƒµä¾¿ç•ªå·å‡¦ç†ã‚’å®Ÿè¡Œ
              setTimeout(() => {
                // å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸­ã§æœ€å¾Œã®ã‚‚ã®ã‚’ç¢ºèª
                const allTextInputs = Array.from(cardContainer.querySelectorAll('input[type="text"]'))
                const lastInput = allTextInputs[allTextInputs.length - 1]
                
                if (input === lastInput) {
                  console.log('ğŸ¯ æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«éƒµä¾¿ç•ªå·ã‚’è¨­å®š:', zipCode)
                  input.value = zipCode
                  input.disabled = true
                  input.style.display = 'none'
                }
              }, 50)
            })
          }
        })
      }
    })
  })
  
  // ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã®å¤‰æ›´ã‚’ç›£è¦–é–‹å§‹
  observer.observe(cardContainer, {
    childList: true,
    subtree: true
  })
  
  // 5ç§’å¾Œã«ç›£è¦–ã‚’åœæ­¢ï¼ˆãƒªã‚½ãƒ¼ã‚¹ç¯€ç´„ï¼‰
  setTimeout(() => {
    observer.disconnect()
    console.log('âœ… å‹•çš„ç›£è¦–ã‚’çµ‚äº†ã—ã¾ã—ãŸ')
  }, 5000)
}

// æ±ºæ¸ˆã‚’å‡¦ç†ï¼ˆéƒµä¾¿ç•ªå·ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å›é¿ç‰ˆï¼‰
export async function processPayment(card, amount, zipCode = '') {
  try {
    console.log('=== ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³åŒ–é–‹å§‹ ===')
    console.log('éƒµä¾¿ç•ªå·æƒ…å ±:', zipCode)
    
    // ãƒˆãƒ¼ã‚¯ãƒ³åŒ–å‰ã«éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†åº¦ç¢ºèªãƒ»å‡¦ç†
    console.log('ğŸ”„ ãƒˆãƒ¼ã‚¯ãƒ³åŒ–å‰ã®éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ€çµ‚ç¢ºèª...')
    const processedFields = disablePostalCodeFields(zipCode)
    
    if (processedFields === 0) {
      console.log('âš ï¸ éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€æ‰‹å‹•ã§æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†ã—ã¾ã™')
      
      // æœ€å¾Œã®æ‰‹æ®µï¼šã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€å¾Œã‚’å¼·åˆ¶çš„ã«å‡¦ç†
      const allInputs = document.querySelectorAll('#card-container input[type="text"]')
      if (allInputs.length > 0) {
        const lastInput = allInputs[allInputs.length - 1]
        if (zipCode && lastInput) {
          console.log('ğŸ¯ æœ€å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¼·åˆ¶çš„ã«éƒµä¾¿ç•ªå·ã‚’è¨­å®š:', zipCode)
          lastInput.value = zipCode
          lastInput.disabled = true
          lastInput.style.display = 'none'
        }
      }
    }
    
    // å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã‚’å®Ÿè¡Œ
    await new Promise(resolve => setTimeout(resolve, 200))
    
    const tokenResult = await card.tokenize()
    console.log('ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³åŒ–å®Œäº†:', tokenResult)
    
    if (tokenResult.status === 'OK') {
      console.log('âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒï¼šã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³åŒ–æˆåŠŸ', tokenResult.token)
      
      // ãƒ†ã‚¹ãƒˆç”¨ã®æ±ºæ¸ˆå‡¦ç†ï¼ˆå¸¸ã«æˆåŠŸï¼‰
      // å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼APIã‚’å‘¼ã³å‡ºã™ä»£ã‚ã‚Šã«ã€æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      await new Promise(resolve => setTimeout(resolve, 1500)) // 1.5ç§’å¾…æ©Ÿ
      
      return {
        status: 'success',
        paymentId: 'test_payment_' + Date.now(),
        transactionId: 'txn_' + Math.random().toString(36).substring(2, 15),
        message: 'ãƒ†ã‚¹ãƒˆæ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸ',
        cardLast4: tokenResult.details?.card?.last4 || '****',
        cardBrand: tokenResult.details?.card?.brand || 'TEST'
      }
    } else {
      console.log('âŒ ãƒˆãƒ¼ã‚¯ãƒ³åŒ–å¤±æ•—:', tokenResult.errors)
      const errorMessage = tokenResult.errors?.[0]?.message || 'ã‚«ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'
      
      // éƒµä¾¿ç•ªå·é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ç‰¹åˆ¥å‡¦ç†
      if (errorMessage.includes('Postal code') || errorMessage.includes('postal')) {
        throw new Error('ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ï¼ˆéƒµä¾¿ç•ªå·ã¯å‰ç”»é¢ã§å…¥åŠ›æ¸ˆã¿ã§ã™ï¼‰')
      }
      
      throw new Error(errorMessage)
    }
  } catch (error) {
    console.error('æ±ºæ¸ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)
    throw error
  }
}
