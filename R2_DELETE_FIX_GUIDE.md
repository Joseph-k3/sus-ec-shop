# R2動画削除機能の修正完了 - 動作確認ガイド

## 🎯 修正内容サマリー

### 問題
`sus-ec-images/products/2025/11/videos/` 配下のR2動画が削除できていなかった

### 原因
1. ファイルキー抽出ロジックが不十分
2. 公開URLの末尾スラッシュが不統一
3. R2削除処理のログが不十分

### 修正
1. ✅ ファイルキー抽出ロジックを大幅改善（複数パターンに対応）
2. ✅ `.env`の公開URLを統一
3. ✅ 詳細なログ出力を追加
4. ✅ テストスクリプトを作成

## 🧪 動作確認手順

### 1. 開発サーバーを再起動

修正を反映するため、開発サーバーを再起動してください：

```bash
# 現在のサーバーを停止（Ctrl+C）
# 再起動
npm run dev
```

### 2. 商品管理画面で動画を削除

1. ブラウザで商品管理画面にアクセス
2. 動画がある商品を編集
3. 動画の「削除」ボタンをクリック
4. 確認ダイアログで「OK」をクリック

### 3. ブラウザコンソールでログを確認

削除時に以下のログが表示されるはずです：

```
🗑️ 動画削除開始: <videoId>
🗑️ 動画削除開始: { videoId, video_url, thumbnail_url, storage_provider }
🗑️ R2削除処理開始: https://pub-xxx.r2.dev/products/2025/11/videos/video_xxx.mp4
✅ 公開URLから抽出: products/2025/11/videos/video_xxx.mp4
🗑️ R2削除リクエスト: { fileUrl, publicBaseUrl, extractedFileKey }
✅ R2削除成功: { success: true, ... }
✅ 動画削除完了: <videoId>
✅ 動画削除成功: <videoId>
```

### 4. R2ダッシュボードで確認（オプション）

1. Cloudflare R2ダッシュボードにログイン
2. `sus-ec-images` バケットを開く
3. `products/2025/11/videos/` フォルダを確認
4. 削除した動画ファイルが存在しないことを確認

### 5. サーバーログを確認（Vercel本番環境の場合）

Vercel Dashboardで以下のログが表示されるはずです：

```
🗑️ R2からファイルを削除: { fileKey, method }
📦 使用するバケット: sus-ec-images
✅ R2削除成功: { fileKey, bucket }
```

## 📋 対応するURL形式

修正後のロジックは以下のURL形式に対応：

1. ✅ `https://pub-e3a78e43359c43d28c0a8c26913fcc6e.r2.dev/products/2025/11/videos/video_1234567890_abc123.mp4`
2. ✅ `https://pub-e3a78e43359c43d28c0a8c26913fcc6e.r2.dev/products/2025/11/videos/thumb_1234567890_abc123.jpg`
3. ✅ `products/2025/11/videos/video_1234567890_abc123.mp4`（パスのみ）
4. ✅ 公開URLの末尾スラッシュありなし両方

## 🔧 トラブルシューティング

### エラー: "ファイルキーを抽出できませんでした"

**原因:** 動画URLが予期しない形式

**確認方法:**
1. ブラウザコンソールで動画URLを確認
2. `.env`の`VITE_CLOUDFLARE_R2_PUBLIC_URL`を確認

**解決策:**
- 動画URLをコンソールに出力して開発者に共有

### エラー: "R2削除APIエラー: 403"

**原因:** R2のアクセスキーが間違っているか、権限が不足

**確認方法:**
```bash
# .envのR2設定を確認
cat .env | grep CLOUDFLARE_R2
```

**解決策:**
- Cloudflare R2ダッシュボードでアクセスキーを再生成
- `.env`を更新して開発サーバーを再起動

### エラー: "R2削除APIエラー: 404"

**原因:** ファイルが既に削除されている（これは正常）

**動作:**
- 警告ログのみ出力され、処理は継続
- DBからは正常に削除される

## 📦 修正ファイル一覧

1. ✅ `src/lib/productVideos.js` - ファイルキー抽出ロジック改善
2. ✅ `src/components/AdminProductEdit.vue` - ユーザーフィードバック改善
3. ✅ `api/r2-delete.js` - ログ出力改善
4. ✅ `.env` - 公開URL統一
5. ✅ `test-r2-delete.js` - テストスクリプト作成（開発用）

## 🚀 本番環境へのデプロイ

修正をVercelにデプロイする場合：

```bash
# 変更をコミット
git add .
git commit -m "fix: R2動画削除機能の修正 - ファイルキー抽出ロジック改善"

# プッシュ（自動デプロイ）
git push origin main
```

**重要:** Vercel環境変数も確認してください：
- `CLOUDFLARE_R2_PUBLIC_URL`の末尾スラッシュを削除
- 開発環境と本番環境で統一されているか確認

## ✅ チェックリスト

- [ ] 開発サーバーを再起動した
- [ ] 動画削除を試した
- [ ] ブラウザコンソールで正常なログを確認した
- [ ] 削除後、商品一覧で動画が消えていることを確認した
- [ ] （オプション）R2ダッシュボードでファイルが削除されていることを確認した
- [ ] 本番環境にデプロイした（必要な場合）
- [ ] Vercel環境変数を更新した（必要な場合）

## 📞 サポート

問題が解決しない場合は、以下の情報を共有してください：

1. ブラウザコンソールのログ（スクリーンショット）
2. 削除しようとした動画のURL
3. `.env`の`VITE_CLOUDFLARE_R2_PUBLIC_URL`の値
4. エラーメッセージ

これで`products/2025/11/videos/`配下の動画も正しく削除できるようになりました！🎉
